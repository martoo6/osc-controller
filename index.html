<HEAD>
  <meta charset="utf-8" />
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1" /> -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/dsmorse-gridster@0.8.0/dist/jquery.dsmorse-gridster.min.css"
    integrity="sha256-U6yBIyg3hrh84a4TxrUxDpqnu5VwurBinfONboy5HPQ="
    crossorigin="anonymous"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.2.0/css/uikit.min.css"
  />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.2.0/js/uikit.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.2.0/js/uikit-icons.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/osc@2.3.1/dist/osc-browser.min.js"
    integrity="sha256-Wp4YbHJny3L/oa4rjj5KBgf22N2JRt99qecF7NDiCNg="
    crossorigin="anonymous"
  ></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/3.3.3/adapter.min.js"></script>

  <script type="text/javascript" src="./instascan.min.js"></script>
  <script src="https://rawgit.com/nexus-js/ui/master/dist/NexusUI.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <script
    src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"
  ></script>

  <script
    src="https://cdn.jsdelivr.net/npm/dsmorse-gridster@0.8.0/dist/jquery.dsmorse-gridster.min.js"
    integrity="sha256-sp0TFdPdkZFLP04spyIuNt1UgbkCF5QdbVWukg15ZCA="
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/dsmorse-gridster@0.8.0/dist/jquery.dsmorse-gridster.with-extras.min.js"
    integrity="sha256-5GqQ+FMGKS1LZVh3+hW8vqdoKCqj0RtOfPT7CipjsoM="
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/dsmorse-gridster@0.8.0/dist/jquery.draggable.js"
    integrity="sha256-1QJM+VlzPtDwGjbbSStzsLWkK76PV+eTeTg2aWAcB20="
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/dsmorse-gridster@0.8.0/dist/jquery.coords.js"
    integrity="sha256-lHUpcEaZRYKO9C9YDUGwL83xW+/guKAk+VMFzjCUMsQ="
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/dsmorse-gridster@0.8.0/dist/jquery.collision.js"
    integrity="sha256-/wuepxQzzUjvUUHwbMXz6QCMHPLzbttQYudKY6S28ME="
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/dsmorse-gridster@0.8.0/dist/utils.js"
    integrity="sha256-o3lRTbzi5wLdWzoy5F9n/00qMuXO9y1xW0ZiPmVJiWs="
    crossorigin="anonymous"
  ></script>

  <style>
    .item {
      text-align: center;
      font-size: 24px;
      font-weight: 300;
      background-color: rgba(255, 255, 255, 0);
      border: 2px solid;
      color: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      border-style: dashed;
      list-style: none;
    }

    .vertical-center {
      margin: 0;
      position: absolute;
      top: 50%;
      left: 50%;
      -ms-transform: translate(-50%, -50%);
      transform: translate(-50%, -50%);
    }

    .horizontal-center {
      margin: 0;
      position: absolute;
      left: 50%;
      -ms-transform: translate(-50%, 0%);
      transform: translate(-50%, 0%);
    }

    .preventclick {
      pointer-events: none;
    }
  </style>
</HEAD>
<BODY style="background-color: #222">
  <div id="qrScannerModal" class="uk-flex-top" uk-modal>
    <div class="uk-modal-dialog uk-margin-auto-vertical">
      <video autoplay="autoplay" id="qrScannerVideo"></video>
    </div>
  </div>

  <div id="qrModal" class="uk-flex-top" uk-modal>
    <div class="uk-modal-dialog uk-margin-auto-vertical">
      <canvas id="qrCanvas"></canvas>
    </div>
  </div>

  <nav
    class="uk-navbar-container"
    uk-navbar="mode: click"
    style="background: #3c3c3c"
  >
    <ul class="uk-navbar-nav">
      <li><a href="#" id="editBtn" uk-toggle="target: #widgets">Edit</a></li>
      <li>
        <a href="#">Zoom</a>
        <div class="uk-navbar-dropdown" style="background: #3c3c3c">
          <ul class="uk-nav uk-navbar-dropdown-nav">
            <li><a href="#" id="zoom0.5XBtn">0.5x</a></li>
            <li><a href="#" id="zoom1XBtn" class="uk-active">1x</a></li>
            <li><a href="#" id="zoom2XBtn">2x</a></li>
          </ul>
        </div>
      </li>
      <li><a href="#" id="shareBtn" uk-toggle="target: #qrModal">Share</a></li>
      <li>
        <a href="#" id="syncBtn" uk-toggle="target: #qrScannerModal">Sync</a>
      </li>
    </ul>

    <div class="uk-navbar-item">
      <input
        id="serverInput"
        class="uk-input uk-form-width-medium"
        type="text"
        value="192.168.0.224:8081"
        style="margin-right: 5px"
      />
      <button id="runBtn" class="uk-button">
        Run
      </button>
    </div>
  </nav>

  <div id="widgets" uk-offcanvas="mode: push">
    <div
      class="uk-offcanvas-bar uk-flex uk-flex-column"
      style="background: #3c3c3c"
    >
      <button class="uk-offcanvas-close" type="button" uk-close></button>
      <a class="uk-navbar-item uk-logo" href="#">Widgets</a>
      <button class="uk-button uk-button-default" id="hSliderBtn">
        Horizontal slider
      </button>
      <button class="uk-button uk-button-default" id="vSliderBtn">
        Vertical slider
      </button>
      <button class="uk-button uk-button-default" id="dialBtn">Dial</button>
      <button class="uk-button uk-button-default" id="buttonBtn">
        Button
      </button>
      <button class="uk-button uk-button-default" id="labelBtn">Label</button>
      <button class="uk-button uk-button-default" id="toggleBtn">
        Toggle
      </button>
    </div>
  </div>

  <div id="controls" class="gridster" style="background: #222">
    <ul style="list-style-type: none; list-style:none;"></ul>
  </div>
  <div style="background: #222; height: 100%;"></div>

  <script>
    const gridsterOptions = {
      widget_margins: [5, 5],
      widget_base_dimensions: [45, 45],
      shift_widgets_up: false,
      shift_larger_widgets_down: false,
      collision: {
        wait_for_mouseup: true
      },
      serialize_params: ($w, wgd) => {
        return {
          c: wgd.col,
          r: wgd.row,
          sx: wgd.size_x,
          sy: wgd.size_y,
          t: $w
            .attr('class')
            .split(/\s+/)
            .filter(x => x != 'item')[0],
          i: parseInt($w.attr('id').split('-')[2])
        };
      },
      max_rows: 100,
      max_cols: 100
    };

    let controls = $('.gridster ul')
      .gridster(gridsterOptions)
      .data('gridster');

    const nexusSize = (xSize, ySize) => {
      return [
        (gridsterOptions.widget_margins[0] +
          gridsterOptions.widget_base_dimensions[0]) *
          xSize -
          gridsterOptions.widget_margins[0],
        (gridsterOptions.widget_margins[1] +
          gridsterOptions.widget_base_dimensions[1]) *
          ySize -
          gridsterOptions.widget_margins[1]
      ];
    };

    let oscApp;

    const elemIndex = {
      button: 0,
      label: 0,
      slider: 0,
      vSlider: 0,
      hSlider: 0,
      dial: 0,
      toggle: 0
    };

    const addButton = (index, col = 0, row = 0) => {
      const xSize = 2;
      const ySize = 2;
      controls.add_widget(
        `<li id="button-parent-${index}" class="item button"><div id="button${index}" class="vertical-center preventclick"></div></li>`,
        xSize,
        ySize,
        col,
        row
      );
      //SAVE ?
      const element = new Nexus.Button(`#button${index}`, {
        size: nexusSize(xSize, ySize),
        mode: 'aftertouch'
      });

      element.on('change', function(v) {
        oscApp.send({
          address: '/buttons/' + index,
          args: [{ type: 'f', value: v }]
        });
      });
    };

    document.getElementById('buttonBtn').onclick = () => {
      const index = elemIndex.button++;
      addButton(index);
    };

    const addLabel = (index, col = 0, row = 0) => {
      const xSize = 4;
      const ySize = 1;
      controls.add_widget(
        `<li id="label-parent-${index}" class="item label"><input id="label${index}" placeholder="Description" class="vertical-center"/></li>`,
        xSize,
        ySize,
        col,
        row
      );
    };

    document.getElementById('labelBtn').onclick = () => {
      const index = elemIndex.label++;
      addLabel(index);
    };

    const addHSlider = (index, col = 0, row = 0) => {
      const xSize = 4;
      const ySize = 1;
      controls.add_widget(
        `<li id="hSlider-parent-${index}" class="item hSlider"><div id="hSlider${index}" class="vertical-center preventclick"></div></li>`,
        xSize,
        ySize,
        col,
        row
      );
      //SAVE ?
      const element = new Nexus.Slider(`#hSlider${index}`, {
        size: nexusSize(xSize, ySize),
        mode: 'relative', // 'relative' or 'absolute'
        min: 0,
        max: 1,
        step: 0,
        value: 0
      });

      element.on('change', function(v) {
        oscApp.send({
          address: '/sliders/' + index,
          args: [{ type: 'f', value: v }]
        });
      });
    };

    document.getElementById('hSliderBtn').onclick = () => {
      const index = elemIndex.slider++;
      addHSlider(index);
    };

    const addVSlider = (index, col = 0, row = 0) => {
      const xSize = 1;
      const ySize = 4;
      controls.add_widget(
        `<li id="vSlider-parent-${index}" class="item vSlider"><div id="vSlider${index}" class="vertical-center preventclick"></div></li>`,
        xSize,
        ySize,
        col,
        row
      );

      const element = new Nexus.Slider(`#vSlider${index}`, {
        size: nexusSize(xSize, ySize),
        mode: 'relative', // 'relative' or 'absolute'
        min: 0,
        max: 1,
        step: 0,
        value: 0
      });

      element.on('change', function(v) {
        oscApp.send({
          address: '/sliders/' + index,
          args: [{ type: 'f', value: v }]
        });
      });
    };

    document.getElementById('vSliderBtn').onclick = () => {
      const index = elemIndex.slider++;
      addVSlider(index);
    };

    const addDial = (index, col = 0, row = 0) => {
      const xSize = 2;
      const ySize = 2;
      controls.add_widget(
        `<li id="dial-parent-${index}" class="item dial"><div id="dial${index}" class="vertical-center preventclick"></div></li>`,
        xSize,
        ySize,
        col,
        row
      );
      const element = new Nexus.Dial(`#dial${index}`, {
        size: nexusSize(xSize, ySize)
      });
      element.on('change', function(v) {
        oscApp.send({
          address: '/dials/' + index,
          args: [{ type: 'f', value: v }]
        });
      });
    };

    document.getElementById('dialBtn').onclick = () => {
      const index = elemIndex.dial++;
      addDial(index);
    };

    const addtoggle = (index, col = 0, row = 0) => {
      const xSize = 2;
      const ySize = 2;
      controls.add_widget(
        `<li id="toggle-parent-${index}" class="item toggle"><div id="toggle${index}" class="vertical-center preventclick"></div></li>`,
        xSize,
        ySize,
        col,
        row
      );

      const element = new Nexus.Toggle(`#toggle${index}`, {
        size: nexusSize(xSize, ySize)
      });

      element.on('change', function(v) {
        oscApp.send({
          address: '/toggles/' + index,
          args: [{ type: 'f', value: v }]
        });
      });
    };

    document.getElementById('toggleBtn').onclick = () => {
      const index = elemIndex.toggle++;
      addtoggle(index);
    };

    let running = false;
    document.getElementById('runBtn').onclick = () => {
      running = !running;
      const pc = Array.from(document.getElementsByClassName('preventclick'));
      const items = Array.from(document.getElementsByClassName('item'));
      if (running) {
        document.getElementById('runBtn').innerHTML = 'Stop';
        pc.forEach(e => (e.style.pointerEvents = 'all'));
        items.forEach(e => (e.style.border = 'none'));
        controls.disable();
        const [host = 'localhost', port = 8081] = document
          .getElementById('serverInput')
          .value.split(':');

        oscApp = new osc.WebSocketPort({
          url: `ws://${host}:${port}`
        });
        oscApp.open();
      } else {
        document.getElementById('runBtn').innerHTML = 'Run';
        pc.forEach(e => (e.style.pointerEvents = 'none'));
        items.forEach(e => (e.style.border = '2px dashed'));
        controls.enable();
        oscApp.close();
      }
    };

    const addNodes = nodes => {
      //Should also user node sx, sy
      for (let node of nodes) {
        const col = node.c;
        const row = node.r;
        const index = node.i;

        if (node.t == 'button') {
          addButton(index, col, row);
        } else if (node.t == 'label') {
          addLabel(index, col, row);
        } else if (node.t == 'vSlider') {
          addVSlider(index, col, row);
        } else if (node.t == 'hSlider') {
          addHSlider(index, col, row);
        } else if (node.t == 'dial') {
          addDial(index, col, row);
        } else if (node.t == 'toggle') {
          addtoggle(index, col, row);
        }
      }
    };

    const restartControls = () => {
      controls.destroy();
      const doc = document.getElementById('controls');
      while (doc.firstChild) {
        doc.firstChild.remove();
      }

      controls = $('#controls')
        .gridster(gridsterOptions)
        .data('gridster');
    };

    const zoomTo = zoomLevel => {
      const baseSize = 50;
      gridsterOptions.widget_base_dimensions = [
        baseSize * zoomLevel - 5,
        baseSize * zoomLevel - 5
      ];
      //Iterar todos los items eliminando sus hijos y re agregar sabiendo la clase.

      const nodes = controls.serialize();

      restartControls();
      addNodes(nodes);
    };

    document.getElementById('zoom0.5XBtn').onclick = () => {
      zoomTo(0.5);
    };
    document.getElementById('zoom1XBtn').onclick = () => {
      zoomTo(1);
    };
    document.getElementById('zoom2XBtn').onclick = () => {
      zoomTo(2);
    };

    document.getElementById('shareBtn').onclick = () => {
      var qr = new QRious({
        element: document.getElementById('qrCanvas'),
        value: JSON.stringify(controls.serialize()),
        size: Math.min(window.innerWidth, window.innerHeight) * 0.9
      });
    };

    document.getElementById('syncBtn').onclick = () => {
      const scanner = new Instascan.Scanner({
        video: document.getElementById('qrScannerVideo'),
        mirror: false,
        backgroundScan: false,
        scanPeriod: 2
      });
      scanner.addListener('scan', function(content) {
        restartControls();
        const nodes = JSON.parse(content);
        addNodes(nodes);
        UIkit.modal(document.getElementById('qrScannerModal')).hide();
        scanner.stop();
      });
      Instascan.Camera.getCameras()
        .then(function(cameras) {
          if (cameras.length > 0) {
            scanner.start(cameras[cameras.length - 1]).catch(e => alert(e));
          } else {
            alert('No cameras found.');
          }
        })
        .catch(function(e) {
          alert(e);
        });
    };
  </script>
</BODY>
